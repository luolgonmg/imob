{"ast":null,"code":"import React,{useState,useEffect,useContext,useRef}from\"react\";import withWidth,{isWidthUp}from\"@material-ui/core/withWidth\";import\"emoji-mart/css/emoji-mart.css\";import{Picker}from\"emoji-mart\";import MicRecorder from\"mic-recorder-to-mp3\";import clsx from\"clsx\";import{isNil}from\"lodash\";import{makeStyles}from\"@material-ui/core/styles\";import Paper from\"@material-ui/core/Paper\";import InputBase from\"@material-ui/core/InputBase\";import CircularProgress from\"@material-ui/core/CircularProgress\";import{green}from\"@material-ui/core/colors\";import AttachFileIcon from\"@material-ui/icons/AttachFile\";import IconButton from\"@material-ui/core/IconButton\";import MoodIcon from\"@material-ui/icons/Mood\";import SendIcon from\"@material-ui/icons/Send\";import CancelIcon from\"@material-ui/icons/Cancel\";import ClearIcon from\"@material-ui/icons/Clear\";import MicIcon from\"@material-ui/icons/Mic\";import CheckCircleOutlineIcon from\"@material-ui/icons/CheckCircleOutline\";import HighlightOffIcon from\"@material-ui/icons/HighlightOff\";import{FormControlLabel,Switch}from\"@material-ui/core\";import Autocomplete from\"@material-ui/lab/Autocomplete\";import{isString,isEmpty,isObject,has}from\"lodash\";import{i18n}from\"../../translate/i18n\";import api from\"../../services/api\";import axios from\"axios\";import RecordingTimer from\"./RecordingTimer\";import{ReplyMessageContext}from\"../../context/ReplyingMessage/ReplyingMessageContext\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{useLocalStorage}from\"../../hooks/useLocalStorage\";import toastError from\"../../errors/toastError\";import useQuickMessages from\"../../hooks/useQuickMessages\";const Mp3Recorder=new MicRecorder({bitRate:128});const useStyles=makeStyles(theme=>({mainWrapper:{backgroundColor:theme.palette.bordabox,//DARK MODE PLW DESIGN//\ndisplay:\"flex\",flexDirection:\"column\",alignItems:\"center\",borderTop:\"1px solid rgba(0, 0, 0, 0.12)\"},newMessageBox:{backgroundColor:theme.palette.newmessagebox,//DARK MODE PLW DESIGN//\nwidth:\"100%\",display:\"flex\",padding:\"7px\",alignItems:\"center\"},messageInputWrapper:{padding:6,marginRight:7,backgroundColor:theme.palette.inputdigita,//DARK MODE PLW DESIGN//\ndisplay:\"flex\",borderRadius:20,flex:1},messageInput:{paddingLeft:10,flex:1,border:\"none\"},sendMessageIcons:{color:\"grey\"},uploadInput:{display:\"none\"},viewMediaInputWrapper:{display:\"flex\",padding:\"10px 13px\",position:\"relative\",justifyContent:\"space-between\",alignItems:\"center\",backgroundColor:\"#eee\",borderTop:\"1px solid rgba(0, 0, 0, 0.12)\"},emojiBox:{position:\"absolute\",bottom:63,width:40,borderTop:\"1px solid #e8e8e8\"},circleLoading:{color:green[500],opacity:\"70%\",position:\"absolute\",top:\"20%\",left:\"50%\",marginLeft:-12},audioLoading:{color:green[500],opacity:\"70%\"},recorderWrapper:{display:\"flex\",alignItems:\"center\",alignContent:\"middle\"},cancelAudioIcon:{color:\"red\"},sendAudioIcon:{color:\"green\"},replyginMsgWrapper:{display:\"flex\",width:\"100%\",alignItems:\"center\",justifyContent:\"center\",paddingTop:8,paddingLeft:73,paddingRight:7},replyginMsgContainer:{flex:1,marginRight:5,overflowY:\"hidden\",backgroundColor:\"rgba(0, 0, 0, 0.05)\",borderRadius:\"7.5px\",display:\"flex\",position:\"relative\"},replyginMsgBody:{padding:10,height:\"auto\",display:\"block\",whiteSpace:\"pre-wrap\",overflow:\"hidden\"},replyginContactMsgSideColor:{flex:\"none\",width:\"4px\",backgroundColor:\"#35cd96\"},replyginSelfMsgSideColor:{flex:\"none\",width:\"4px\",backgroundColor:\"#6bcbef\"},messageContactName:{display:\"flex\",color:\"#6bcbef\",fontWeight:500}}));const EmojiOptions=props=>{const{disabled,showEmoji,setShowEmoji,handleAddEmoji}=props;const classes=useStyles();return/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(IconButton,{\"aria-label\":\"emojiPicker\",component:\"span\",disabled:disabled,onClick:e=>setShowEmoji(prevState=>!prevState)},/*#__PURE__*/React.createElement(MoodIcon,{className:classes.sendMessageIcons})),showEmoji?/*#__PURE__*/React.createElement(\"div\",{className:classes.emojiBox},/*#__PURE__*/React.createElement(Picker,{perLine:16,showPreview:false,showSkinTones:false,onSelect:handleAddEmoji})):null);};const SignSwitch=props=>{const{width,setSignMessage,signMessage}=props;if(isWidthUp(\"md\",width)){return/*#__PURE__*/React.createElement(FormControlLabel,{style:{marginRight:7,color:\"gray\"},label:i18n.t(\"messagesInput.signMessage\"),labelPlacement:\"start\",control:/*#__PURE__*/React.createElement(Switch,{size:\"small\",checked:signMessage,onChange:e=>{setSignMessage(e.target.checked);},name:\"showAllTickets\",color:\"primary\"})});}return null;};const FileInput=props=>{const{handleChangeMedias,disableOption}=props;const classes=useStyles();return/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(\"input\",{multiple:true,type:\"file\",id:\"upload-button\",disabled:disableOption(),className:classes.uploadInput,onChange:handleChangeMedias}),/*#__PURE__*/React.createElement(\"label\",{htmlFor:\"upload-button\"},/*#__PURE__*/React.createElement(IconButton,{\"aria-label\":\"upload\",component:\"span\",disabled:disableOption()},/*#__PURE__*/React.createElement(AttachFileIcon,{className:classes.sendMessageIcons}))));};const ActionButtons=props=>{const{inputMessage,loading,recording,ticketStatus,handleSendMessage,handleCancelAudio,handleUploadAudio,handleStartRecording}=props;const classes=useStyles();if(inputMessage){return/*#__PURE__*/React.createElement(IconButton,{\"aria-label\":\"sendMessage\",component:\"span\",onClick:handleSendMessage,disabled:loading},/*#__PURE__*/React.createElement(SendIcon,{className:classes.sendMessageIcons}));}else if(recording){return/*#__PURE__*/React.createElement(\"div\",{className:classes.recorderWrapper},/*#__PURE__*/React.createElement(IconButton,{\"aria-label\":\"cancelRecording\",component:\"span\",fontSize:\"large\",disabled:loading,onClick:handleCancelAudio},/*#__PURE__*/React.createElement(HighlightOffIcon,{className:classes.cancelAudioIcon})),loading?/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(CircularProgress,{className:classes.audioLoading})):/*#__PURE__*/React.createElement(RecordingTimer,null),/*#__PURE__*/React.createElement(IconButton,{\"aria-label\":\"sendRecordedAudio\",component:\"span\",onClick:handleUploadAudio,disabled:loading},/*#__PURE__*/React.createElement(CheckCircleOutlineIcon,{className:classes.sendAudioIcon})));}else{return/*#__PURE__*/React.createElement(IconButton,{\"aria-label\":\"showRecorder\",component:\"span\",disabled:loading||ticketStatus!==\"open\",onClick:handleStartRecording},/*#__PURE__*/React.createElement(MicIcon,{className:classes.sendMessageIcons}));}};const CustomInput=props=>{const{loading,inputRef,ticketStatus,inputMessage,setInputMessage,handleSendMessage,handleInputPaste,disableOption,handleQuickAnswersClick}=props;const classes=useStyles();const[quickMessages,setQuickMessages]=useState([]);const[options,setOptions]=useState([]);const[popupOpen,setPopupOpen]=useState(false);const{user}=useContext(AuthContext);const{list:listQuickMessages}=useQuickMessages();useEffect(()=>{async function fetchData(){const companyId=localStorage.getItem(\"companyId\");const messages=await listQuickMessages({companyId,userId:user.id});const options=messages.map(m=>{let truncatedMessage=m.message;if(isString(truncatedMessage)&&truncatedMessage.length>35){truncatedMessage=m.message.substring(0,35)+\"...\";}return{value:m.message,label:\"/\".concat(m.shortcode,\" - \").concat(truncatedMessage),mediaPath:m.mediaPath};});setQuickMessages(options);}fetchData();// eslint-disable-next-line react-hooks/exhaustive-deps\n},[]);useEffect(()=>{if(isString(inputMessage)&&!isEmpty(inputMessage)&&inputMessage.length>1){const firstWord=inputMessage.charAt(0);setPopupOpen(firstWord.indexOf(\"/\")>-1);const filteredOptions=quickMessages.filter(m=>m.label.indexOf(inputMessage)>-1);setOptions(filteredOptions);}else{setPopupOpen(false);}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[inputMessage]);const onKeyPress=e=>{if(loading||e.shiftKey)return;else if(e.key===\"Enter\"){handleSendMessage();}};const onPaste=e=>{if(ticketStatus===\"open\"){handleInputPaste(e);}};const renderPlaceholder=()=>{if(ticketStatus===\"open\"){return i18n.t(\"messagesInput.placeholderOpen\");}return i18n.t(\"messagesInput.placeholderClosed\");};const setInputRef=input=>{if(input){input.focus();inputRef.current=input;}};return/*#__PURE__*/React.createElement(\"div\",{className:classes.messageInputWrapper},/*#__PURE__*/React.createElement(Autocomplete,{freeSolo:true,open:popupOpen,id:\"grouped-demo\",value:inputMessage,options:options,closeIcon:null,getOptionLabel:option=>{if(isObject(option)){return option.label;}else{return option;}},onChange:(event,opt)=>{if(isObject(opt)&&has(opt,\"value\")&&isNil(opt.mediaPath)){setInputMessage(opt.value);setTimeout(()=>{inputRef.current.scrollTop=inputRef.current.scrollHeight;},200);}else if(isObject(opt)&&has(opt,\"value\")&&!isNil(opt.mediaPath)){handleQuickAnswersClick(opt);setTimeout(()=>{inputRef.current.scrollTop=inputRef.current.scrollHeight;},200);}},onInputChange:(event,opt,reason)=>{if(reason===\"input\"){setInputMessage(event.target.value);}},onPaste:onPaste,onKeyPress:onKeyPress,style:{width:\"100%\"},renderInput:params=>{const{InputLabelProps,InputProps,...rest}=params;return/*#__PURE__*/React.createElement(InputBase,Object.assign({},params.InputProps,rest,{disabled:disableOption(),inputRef:setInputRef,placeholder:renderPlaceholder(),multiline:true,className:classes.messageInput,maxRows:5}));}}));};const MessageInputCustom=props=>{var _medias$;const{ticketStatus,ticketId}=props;const classes=useStyles();const[medias,setMedias]=useState([]);const[inputMessage,setInputMessage]=useState(\"\");const[showEmoji,setShowEmoji]=useState(false);const[loading,setLoading]=useState(false);const[recording,setRecording]=useState(false);const inputRef=useRef();const{setReplyingMessage,replyingMessage}=useContext(ReplyMessageContext);const{user}=useContext(AuthContext);const[signMessage,setSignMessage]=useLocalStorage(\"signOption\",true);useEffect(()=>{inputRef.current.focus();},[replyingMessage]);useEffect(()=>{inputRef.current.focus();return()=>{setInputMessage(\"\");setShowEmoji(false);setMedias([]);setReplyingMessage(null);};},[ticketId,setReplyingMessage]);// const handleChangeInput = e => {\n// \tif (isObject(e) && has(e, 'value')) {\n// \t\tsetInputMessage(e.value);\n// \t} else {\n// \t\tsetInputMessage(e.target.value)\n// \t}\n// };\nconst handleAddEmoji=e=>{let emoji=e.native;setInputMessage(prevState=>prevState+emoji);};const handleChangeMedias=e=>{if(!e.target.files){return;}const selectedMedias=Array.from(e.target.files);setMedias(selectedMedias);};const handleInputPaste=e=>{if(e.clipboardData.files[0]){setMedias([e.clipboardData.files[0]]);}};const handleUploadQuickMessageMedia=async(blob,message)=>{setLoading(true);try{const extension=blob.type.split(\"/\")[1];const formData=new FormData();const filename=\"\".concat(new Date().getTime(),\".\").concat(extension);formData.append(\"medias\",blob,filename);formData.append(\"body\",message);formData.append(\"fromMe\",true);await api.post(\"/messages/\".concat(ticketId),formData);}catch(err){toastError(err);setLoading(false);}setLoading(false);};const handleQuickAnswersClick=async value=>{if(value.mediaPath){try{const{data}=await axios.get(value.mediaPath,{responseType:\"blob\"});handleUploadQuickMessageMedia(data,value.value);setInputMessage(\"\");return;//  handleChangeMedias(response)\n}catch(err){toastError(err);}}setInputMessage(\"\");setInputMessage(value.value);};const handleUploadMedia=async e=>{setLoading(true);e.preventDefault();const formData=new FormData();formData.append(\"fromMe\",true);medias.forEach(media=>{formData.append(\"medias\",media);formData.append(\"body\",media.name);});try{await api.post(\"/messages/\".concat(ticketId),formData);}catch(err){toastError(err);}setLoading(false);setMedias([]);};const handleSendMessage=async()=>{if(inputMessage.trim()===\"\")return;setLoading(true);const message={read:1,fromMe:true,mediaUrl:\"\",body:signMessage?\"*\".concat(user===null||user===void 0?void 0:user.name,\":*\\n\").concat(inputMessage.trim()):inputMessage.trim(),quotedMsg:replyingMessage};try{await api.post(\"/messages/\".concat(ticketId),message);}catch(err){toastError(err);}setInputMessage(\"\");setShowEmoji(false);setLoading(false);setReplyingMessage(null);};const handleStartRecording=async()=>{setLoading(true);try{await navigator.mediaDevices.getUserMedia({audio:true});await Mp3Recorder.start();setRecording(true);setLoading(false);}catch(err){toastError(err);setLoading(false);}};const handleUploadAudio=async()=>{setLoading(true);try{const[,blob]=await Mp3Recorder.stop().getMp3();if(blob.size<10000){setLoading(false);setRecording(false);return;}const formData=new FormData();const filename=\"audio-record-site-\".concat(new Date().getTime(),\".mp3\");formData.append(\"medias\",blob,filename);formData.append(\"body\",filename);formData.append(\"fromMe\",true);await api.post(\"/messages/\".concat(ticketId),formData);}catch(err){toastError(err);}setRecording(false);setLoading(false);};const handleCancelAudio=async()=>{try{await Mp3Recorder.stop().getMp3();setRecording(false);}catch(err){toastError(err);}};const disableOption=()=>{return loading||recording||ticketStatus!==\"open\";};const renderReplyingMessage=message=>{var _message$contact;return/*#__PURE__*/React.createElement(\"div\",{className:classes.replyginMsgWrapper},/*#__PURE__*/React.createElement(\"div\",{className:classes.replyginMsgContainer},/*#__PURE__*/React.createElement(\"span\",{className:clsx(classes.replyginContactMsgSideColor,{[classes.replyginSelfMsgSideColor]:!message.fromMe})}),/*#__PURE__*/React.createElement(\"div\",{className:classes.replyginMsgBody},!message.fromMe&&/*#__PURE__*/React.createElement(\"span\",{className:classes.messageContactName},(_message$contact=message.contact)===null||_message$contact===void 0?void 0:_message$contact.name),message.body)),/*#__PURE__*/React.createElement(IconButton,{\"aria-label\":\"showRecorder\",component:\"span\",disabled:loading||ticketStatus!==\"open\",onClick:()=>setReplyingMessage(null)},/*#__PURE__*/React.createElement(ClearIcon,{className:classes.sendMessageIcons})));};if(medias.length>0)return/*#__PURE__*/React.createElement(Paper,{elevation:0,square:true,className:classes.viewMediaInputWrapper},/*#__PURE__*/React.createElement(IconButton,{\"aria-label\":\"cancel-upload\",component:\"span\",onClick:e=>setMedias([])},/*#__PURE__*/React.createElement(CancelIcon,{className:classes.sendMessageIcons})),loading?/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(CircularProgress,{className:classes.circleLoading})):/*#__PURE__*/React.createElement(\"span\",null,(_medias$=medias[0])===null||_medias$===void 0?void 0:_medias$.name),/*#__PURE__*/React.createElement(IconButton,{\"aria-label\":\"send-upload\",component:\"span\",onClick:handleUploadMedia,disabled:loading},/*#__PURE__*/React.createElement(SendIcon,{className:classes.sendMessageIcons})));else{return/*#__PURE__*/React.createElement(Paper,{square:true,elevation:0,className:classes.mainWrapper},replyingMessage&&renderReplyingMessage(replyingMessage),/*#__PURE__*/React.createElement(\"div\",{className:classes.newMessageBox},/*#__PURE__*/React.createElement(EmojiOptions,{disabled:disableOption(),handleAddEmoji:handleAddEmoji,showEmoji:showEmoji,setShowEmoji:setShowEmoji}),/*#__PURE__*/React.createElement(FileInput,{disableOption:disableOption,handleChangeMedias:handleChangeMedias}),/*#__PURE__*/React.createElement(SignSwitch,{width:props.width,setSignMessage:setSignMessage,signMessage:signMessage}),/*#__PURE__*/React.createElement(CustomInput,{loading:loading,inputRef:inputRef,ticketStatus:ticketStatus,inputMessage:inputMessage,setInputMessage:setInputMessage// handleChangeInput={handleChangeInput}\n,handleSendMessage:handleSendMessage,handleInputPaste:handleInputPaste,disableOption:disableOption,handleQuickAnswersClick:handleQuickAnswersClick}),/*#__PURE__*/React.createElement(ActionButtons,{inputMessage:inputMessage,loading:loading,recording:recording,ticketStatus:ticketStatus,handleSendMessage:handleSendMessage,handleCancelAudio:handleCancelAudio,handleUploadAudio:handleUploadAudio,handleStartRecording:handleStartRecording})));}};export default withWidth()(MessageInputCustom);","map":null,"metadata":{},"sourceType":"module"}